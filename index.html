<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการลานจอดรถสนามบิน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .tab-button { transition: all 0.3s ease; }
        .tab-button.active { border-bottom-color: #0ea5e9; color: #0ea5e9; font-weight: 600; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .section { display: none; }
        .section.active { display: block; }
        @media print {
            body * { visibility: hidden; }
            #receipt-modal-content, #receipt-modal-content * { visibility: visible; }
            #receipt-modal-content { position: absolute; left: 0; top: 0; width: 100%; }
            #receipt-print-button, #receipt-close-button { display: none; }
        }
    </style>
</head>
<body class="bg-stone-50 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900">ระบบจัดการลานจอดรถ</h1>
            <p class="text-slate-500 mt-1">แดชบอร์ดสำหรับบริหารธุรกิจที่จอดรถและบริการรับส่งสนามบิน</p>
        </header>

        <nav class="mb-8 border-b border-slate-200">
            <div class="flex space-x-2 sm:space-x-4">
                <button data-tab="dashboard" class="tab-button py-3 px-2 sm:px-4 border-b-2 border-transparent text-slate-600 hover:text-sky-600">ภาพรวม</button>
                <button data-tab="bookings" class="tab-button py-3 px-2 sm:px-4 border-b-2 border-transparent text-slate-600 hover:text-sky-600">จัดการการจอง</button>
                <button data-tab="expenses" class="tab-button py-3 px-2 sm:px-4 border-b-2 border-transparent text-slate-600 hover:text-sky-600">บันทึกค่าใช้จ่าย</button>
                <button data-tab="booking-form" class="tab-button py-3 px-2 sm:px-4 border-b-2 border-transparent text-slate-600 hover:text-sky-600">ฟอร์มรับจอง</button>
            </div>
        </nav>

        <main>
            <section id="dashboard" class="section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-slate-500 text-sm font-medium">รถที่จอดอยู่ปัจจุบัน</h3>
                        <p id="current-cars-stat" class="text-3xl font-bold text-sky-600 mt-1">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-slate-500 text-sm font-medium">ยอดจองทั้งหมด</h3>
                        <p id="total-bookings-stat" class="text-3xl font-bold text-slate-800 mt-1">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-slate-500 text-sm font-medium">รายรับโดยประมาณ (เดือนนี้)</h3>
                        <p id="monthly-revenue-stat" class="text-3xl font-bold text-green-600 mt-1">฿0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-slate-500 text-sm font-medium">ค่าใช้จ่าย (เดือนนี้)</h3>
                        <p id="monthly-expense-stat" class="text-3xl font-bold text-red-600 mt-1">฿0</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                     <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-lg mb-4">ภาพรวมการจอง 7 วันข้างหน้า</h3>
                        <div class="chart-container">
                            <canvas id="bookingsChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-lg mb-4">รถเข้า-ออกวันนี้</h3>
                        <div id="today-activity" class="space-y-3">
                           <p class="text-slate-500">ไม่มีกิจกรรมสำหรับวันนี้</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="bookings" class="section">
                 <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-xl font-semibold mb-2 sm:mb-0">รายการจองทั้งหมด</h2>
                        <input type="text" id="booking-search" placeholder="ค้นหาด้วยชื่อ หรือ ทะเบียนรถ..." class="w-full sm:w-64 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b border-slate-200 text-sm text-slate-600">
                                <tr>
                                    <th class="p-3">ลูกค้า</th>
                                    <th class="p-3">ทะเบียนรถ</th>
                                    <th class="p-3">วันเข้า-ออก</th>
                                    <th class="p-3">ยอดรวม</th>
                                    <th class="p-3">สถานะ</th>
                                    <th class="p-3"></th>
                                </tr>
                            </thead>
                            <tbody id="bookings-table-body">
                                <tr><td colspan="6" class="text-center p-8 text-slate-500">กำลังโหลดข้อมูลการจอง...</td></tr>
                            </tbody>
                        </table>
                    </div>
                 </div>
            </section>

            <section id="expenses" class="section">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-semibold mb-4">เพิ่มรายการค่าใช้จ่าย</h2>
                        <form id="expense-form" class="space-y-4">
                            <div>
                                <label for="expense-date" class="block text-sm font-medium text-slate-700">วันที่</label>
                                <input type="date" id="expense-date" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                            </div>
                            <div>
                                <label for="expense-description" class="block text-sm font-medium text-slate-700">รายการ</label>
                                <input type="text" id="expense-description" placeholder="เช่น ค่าน้ำมันรถรับส่ง" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                            </div>
                            <div>
                                <label for="expense-amount" class="block text-sm font-medium text-slate-700">จำนวนเงิน (บาท)</label>
                                <input type="number" id="expense-amount" min="0" step="0.01" placeholder="300" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                            </div>
                            <div>
                                <label for="expense-category" class="block text-sm font-medium text-slate-700">หมวดหมู่</label>
                                <select id="expense-category" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                                    <option>ค่าน้ำมันรถรับส่ง</option>
                                    <option>ค่าบำรุงรักษา</option>
                                    <option>ค่าเช่าที่</option>
                                    <option>ค่าการตลาด</option>
                                    <option>เงินเดือน</option>
                                    <option>อื่นๆ</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">บันทึกค่าใช้จ่าย</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-semibold mb-4">ประวัติค่าใช้จ่าย</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 border-b border-slate-200 text-sm text-slate-600">
                                    <tr>
                                        <th class="p-3">วันที่</th>
                                        <th class="p-3">รายการ</th>
                                        <th class="p-3">หมวดหมู่</th>
                                        <th class="p-3 text-right">จำนวนเงิน</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-table-body">
                                    <tr><td colspan="4" class="text-center p-8 text-slate-500">กำลังโหลดข้อมูลค่าใช้จ่าย...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-6">
                            <h3 class="font-semibold text-lg mb-4">สัดส่วนค่าใช้จ่าย</h3>
                            <div class="chart-container h-64 md:h-80">
                                <canvas id="expensesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="booking-form" class="section">
                 <div class="max-w-2xl mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-1">ฟอร์มจองที่จอดรถ</h2>
                    <p class="text-slate-500 mb-6">กรุณากรอกข้อมูลให้ครบถ้วนเพื่อทำการจอง</p>
                    <form id="customer-booking-form" class="space-y-4">
                        <h3 class="text-lg font-semibold border-b pb-2">ข้อมูลผู้ติดต่อ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="customer-name" class="block text-sm font-medium text-slate-700">ชื่อ-นามสกุล</label>
                                <input type="text" id="customer-name" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                             <div>
                                <label for="customer-phone" class="block text-sm font-medium text-slate-700">เบอร์โทรศัพท์</label>
                                <input type="tel" id="customer-phone" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                        </div>
                         <div>
                            <label for="customer-email" class="block text-sm font-medium text-slate-700">อีเมล</label>
                            <input type="email" id="customer-email" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <h3 class="text-lg font-semibold border-b pt-4 pb-2">ข้อมูลรถยนต์</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="car-make" class="block text-sm font-medium text-slate-700">ยี่ห้อรถ</label>
                                <input type="text" id="car-make" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                             <div>
                                <label for="car-model" class="block text-sm font-medium text-slate-700">รุ่นรถ</label>
                                <input type="text" id="car-model" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="car-color" class="block text-sm font-medium text-slate-700">สีรถ</label>
                                <input type="text" id="car-color" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                             <div>
                                <label for="car-plate" class="block text-sm font-medium text-slate-700">ทะเบียนรถ</label>
                                <input type="text" id="car-plate" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold border-b pt-4 pb-2">ข้อมูลการเดินทาง</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="dropoff-date" class="block text-sm font-medium text-slate-700">วันที่นำรถมาฝาก</label>
                                <input type="date" id="dropoff-date" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                             <div>
                                <label for="pickup-date" class="block text-sm font-medium text-slate-700">วันที่มารับรถคืน</label>
                                <input type="date" id="pickup-date" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                        </div>
                        <div class="pt-6">
                            <button type="submit" class="w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 text-lg">ยืนยันการจอง</button>
                        </div>
                    </form>
                 </div>
            </section>
        </main>
    </div>

    <div id="receipt-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 opacity-0 pointer-events-none">
        <div id="receipt-modal-content" class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl transform scale-95">
        </div>
    </div>
    
    <div id="alert-message" class="fixed top-5 right-5 text-white py-2 px-6 rounded-lg shadow-lg opacity-0 transform translate-y-10 transition-all duration-300">
        <p>ข้อความแจ้งเตือน!</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded and parsed. Initializing script...");

            // !!! สำคัญ: ใส่ URL ของ Google Apps Script Web App ที่ Deploy แล้วของคุณจริงๆ !!!
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwgXIdUvE2zxxkqhAtzNMTyIUtMZdM-xwXCx6YoWgFUH5qBbNecJoP08TTjI6MVepg/exec'; 
            // Placeholder เดิมสำหรับเงื่อนไข (ไม่ต้องแก้ไข):
            const PLACEHOLDER_URL = 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE';
            
            const DAILY_RATE = 100;
            let bookings = [];
            let expenses = [];
            
            let bookingsChartInstance = null;
            let expensesChartInstance = null;

            const tabs = document.querySelectorAll('.tab-button');
            const sections = document.querySelectorAll('.section');
            const bookingsTableBody = document.getElementById('bookings-table-body');
            const expensesTableBody = document.getElementById('expenses-table-body');
            const customerBookingForm = document.getElementById('customer-booking-form');
            const expenseForm = document.getElementById('expense-form');
            const bookingSearchInput = document.getElementById('booking-search');

            console.log("Constants and initial variables set.");
            console.log("WEB_APP_URL is currently:", WEB_APP_URL); // Log URL ที่ใช้
            console.log("Tabs found:", tabs.length);
            console.log("Sections found:", sections.length);

            // --- ฟังก์ชัน Helpers ---
            function navigateTo(tabName) {
                console.log("navigateTo called with tabName:", tabName);
                tabs.forEach(tab => {
                    const isActive = tab.dataset.tab === tabName;
                    tab.classList.toggle('active', isActive);
                });
                sections.forEach(section => {
                    const isActive = section.id === tabName;
                    section.classList.toggle('active', isActive);
                });
                window.location.hash = tabName;
                if (tabName === 'dashboard') { // อัปเดต dashboard เมื่อ tab ถูกเลือกและข้อมูลพร้อม
                    updateDashboard();
                }
            }

            function getThaiDate(dateString) {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return 'Invalid Date';
                    return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
                } catch (e) { return 'Invalid Date'; }
            }

            function calculateParkingDays(startDate, endDate) {
                if (!startDate || !endDate) return 0;
                try {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    if (isNaN(start.getTime()) || isNaN(end.getTime())) return 0;
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return Math.max(1, diffDays);
                } catch (e) { return 0; }
            }
            
            function calculateCosts(days) {
                const subtotal = days * DAILY_RATE;
                const vat = subtotal * 0.07;
                const total = subtotal + vat;
                return { subtotal, vat, total };
            }

            // --- ฟังก์ชันโหลดข้อมูล ---
            async function loadBookings() {
                console.log("Attempting to load bookings from:", WEB_APP_URL + '?action=getBookings');
                if (!bookingsTableBody) { console.error("bookingsTableBody is null!"); return; }
                bookingsTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-slate-500">กำลังโหลดข้อมูลการจอง...</td></tr>';
                try {
                    const response = await fetch(WEB_APP_URL + '?action=getBookings');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    console.log("Bookings data from server:", result);
                    if (result.status === 'success') {
                        bookings = result.data || [];
                    } else {
                        console.error('Error loading bookings (API):', result.message);
                        bookings = [];
                        showAlert('ไม่สามารถโหลดข้อมูลการจองได้: ' + result.message, false);
                    }
                } catch (error) {
                    console.error('Fetch error loading bookings:', error);
                    bookings = [];
                    showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อเพื่อโหลดการจอง: ' + error.message, false);
                }
                renderBookingsTable();
            }

            async function loadExpenses() {
                console.log("Attempting to load expenses from:", WEB_APP_URL + '?action=getExpenses');
                if (!expensesTableBody) { console.error("expensesTableBody is null!"); return;}
                expensesTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-slate-500">กำลังโหลดข้อมูลค่าใช้จ่าย...</td></tr>';
                try {
                    const response = await fetch(WEB_APP_URL + '?action=getExpenses');
                     if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    console.log("Expenses data from server:", result);
                    if (result.status === 'success') {
                        expenses = result.data || [];
                    } else {
                        console.error('Error loading expenses (API):', result.message);
                        expenses = [];
                        showAlert('ไม่สามารถโหลดข้อมูลค่าใช้จ่ายได้: ' + result.message, false);
                    }
                } catch (error) {
                    console.error('Fetch error loading expenses:', error);
                    expenses = [];
                    showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อเพื่อโหลดค่าใช้จ่าย: ' + error.message, false);
                }
                renderExpensesTable();
                renderExpensesChart();
            }

            // --- ฟังก์ชัน Render UI ---
            function renderBookingsTable(filteredBookings) {
                // ... (โค้ด renderBookingsTable เหมือนเดิมกับเวอร์ชันล่าสุดที่ผมให้ไป)
                console.log("Rendering bookings table...");
                if (!bookingsTableBody) { console.error("bookingsTableBody is null during render!"); return; }

                const dataToRender = filteredBookings || bookings;
                bookingsTableBody.innerHTML = '';
                if (!dataToRender || dataToRender.length === 0) {
                    bookingsTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-slate-500">ไม่พบข้อมูลการจอง</td></tr>';
                    return;
                }
                dataToRender.forEach(b => {
                    const days = calculateParkingDays(b.DropoffDate, b.PickupDate); 
                    const { total } = calculateCosts(days);
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-200 hover:bg-slate-50';
                    row.innerHTML = `
                        <td class="p-3">
                            <div class="font-semibold">${b.CustomerName || 'N/A'}</div>
                            <div class="text-sm text-slate-500">${b.Phone || 'N/A'}</div>
                        </td>
                        <td class="p-3">${b.CarPlate || 'N/A'}</td>
                        <td class="p-3">${getThaiDate(b.DropoffDate)} - ${getThaiDate(b.PickupDate)} (${days} วัน)</td>
                        <td class="p-3">${total.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</td>
                        <td class="p-3">
                            <select data-id="${b.ID}" class="payment-status-select text-sm rounded-lg border-slate-300 p-1 ${b.PaymentStatus === 'ชำระแล้ว' ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800'}">
                                <option value="รอชำระเงิน" ${b.PaymentStatus === 'รอชำระเงิน' ? 'selected' : ''}>รอชำระเงิน</option>
                                <option value="ชำระแล้ว" ${b.PaymentStatus === 'ชำระแล้ว' ? 'selected' : ''}>ชำระแล้ว</option>
                            </select>
                        </td>
                        <td class="p-3 text-right">
                            <button data-id="${b.ID}" class="view-receipt-btn text-sky-600 hover:text-sky-800 font-semibold">ใบเสร็จ</button>
                        </td>
                    `;
                    bookingsTableBody.appendChild(row);
                });
            }
            
            function renderExpensesTable() {
                // ... (โค้ด renderExpensesTable เหมือนเดิมกับเวอร์ชันล่าสุดที่ผมให้ไป)
                console.log("Rendering expenses table...");
                if (!expensesTableBody) { console.error("expensesTableBody is null during render!"); return; }
                expensesTableBody.innerHTML = '';
                 if (!expenses || expenses.length === 0) {
                    expensesTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-slate-500">ยังไม่มีข้อมูลค่าใช้จ่าย</td></tr>';
                    return;
                }
                expenses.forEach(e => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-200';
                    row.innerHTML = `
                        <td class="p-3">${getThaiDate(e.Date)}</td>
                        <td class="p-3">${e.Description || 'N/A'}</td>
                        <td class="p-3">${e.Category || 'N/A'}</td>
                        <td class="p-3 text-right">${(parseFloat(e.Amount) || 0).toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</td>
                    `;
                    expensesTableBody.appendChild(row);
                });
            }

            function updateDashboard() {
                 // ... (โค้ด updateDashboard เหมือนเดิมกับเวอร์ชันล่าสุดที่ผมให้ไป)
                console.log("Updating dashboard...");
                if (!bookings || !expenses) {
                    console.warn("Bookings or expenses data not available for dashboard update.");
                    return;
                }
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const thisMonth = now.getMonth();
                const thisYear = now.getFullYear();

                const currentCars = (bookings || []).filter(b => {
                    try { return new Date(b.DropoffDate) <= now && new Date(b.PickupDate) >= now; } catch(e){return false;}
                }).length;
                document.getElementById('current-cars-stat').textContent = currentCars;
                document.getElementById('total-bookings-stat').textContent = (bookings || []).length;

                const monthlyRevenue = (bookings || []).filter(b => {
                    try {
                        const pickupDate = new Date(b.PickupDate);
                        return b.PaymentStatus === 'ชำระแล้ว' && pickupDate.getMonth() === thisMonth && pickupDate.getFullYear() === thisYear;
                    } catch(e) { return false; }
                }).reduce((sum, b) => {
                    const days = calculateParkingDays(b.DropoffDate, b.PickupDate);
                    const { total } = calculateCosts(days);
                    return sum + total;
                }, 0);
                document.getElementById('monthly-revenue-stat').textContent = `฿${Math.round(monthlyRevenue).toLocaleString()}`;
                
                const monthlyExpense = (expenses || []).filter(e => {
                     try {
                        const expenseDate = new Date(e.Date);
                        return expenseDate.getMonth() === thisMonth && expenseDate.getFullYear() === thisYear;
                     } catch(e) { return false; }
                }).reduce((sum, e) => sum + (parseFloat(e.Amount) || 0), 0);
                document.getElementById('monthly-expense-stat').textContent = `฿${Math.round(monthlyExpense).toLocaleString()}`;

                const todayActivityEl = document.getElementById('today-activity');
                if(todayActivityEl) {
                    todayActivityEl.innerHTML = '';
                    const todayArrivals = (bookings || []).filter(b => b.DropoffDate === todayStr);
                    const todayDepartures = (bookings || []).filter(b => b.PickupDate === todayStr);
                    
                    if (todayArrivals.length === 0 && todayDepartures.length === 0) {
                        todayActivityEl.innerHTML = '<p class="text-slate-500">ไม่มีกิจกรรมสำหรับวันนี้</p>';
                    } else {
                        todayArrivals.forEach(b => {
                            todayActivityEl.innerHTML += `<div class="flex items-center text-green-600"><span class="mr-2">✈️</span> <span>ขาเข้า: ${b.CustomerName || ''} (${b.CarPlate || ''})</span></div>`;
                        });
                        todayDepartures.forEach(b => {
                            todayActivityEl.innerHTML += `<div class="flex items-center text-red-600"><span class="mr-2">🚗</span> <span>ขาออก: ${b.CustomerName || ''} (${b.CarPlate || ''})</span></div>`;
                        });
                    }
                }
                renderBookingsChart();
            }

            function renderBookingsChart() {
                // ... (โค้ด renderBookingsChart เหมือนเดิมกับเวอร์ชันล่าสุดที่ผมให้ไป)
                console.log("Rendering bookings chart...");
                const bookingsChartEl = document.getElementById('bookingsChart');
                if (!bookingsChartEl) { console.error("bookingsChart element not found!"); return; }
                const ctx = bookingsChartEl.getContext('2d');
                const labels = [];
                const data = [];

                for (let i = 0; i < 7; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() + i);
                    labels.push(date.toLocaleDateString('th-TH', { weekday: 'short', day: 'numeric' }));
                    const bookingsOnDate = (bookings || []).filter(b => {
                        try {
                            const start = new Date(b.DropoffDate); start.setHours(0,0,0,0);
                            const end = new Date(b.PickupDate); end.setHours(0,0,0,0);
                            if (isNaN(start.getTime()) || isNaN(end.getTime())) return false;
                            return date >= start && date <= end;
                        } catch(e){ return false; }
                    }).length;
                    data.push(bookingsOnDate);
                }

                if (bookingsChartInstance) bookingsChartInstance.destroy();
                bookingsChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'จำนวนรถที่จอด', data, backgroundColor: 'rgba(14, 165, 233, 0.6)', borderColor: 'rgba(14, 165, 233, 1)', borderWidth: 1, borderRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
                });
            }
            
            function renderExpensesChart() {
                // ... (โค้ด renderExpensesChart เหมือนเดิมกับเวอร์ชันล่าสุดที่ผมให้ไป)
                console.log("Rendering expenses chart...");
                const expensesChartEl = document.getElementById('expensesChart');
                if (!expensesChartEl) { console.error("expensesChart element not found!"); return; }
                const ctx = expensesChartEl.getContext('2d');
                const categoryTotals = (expenses || []).reduce((acc, expense) => {
                    acc[expense.Category] = (acc[expense.Category] || 0) + (parseFloat(expense.Amount) || 0);
                    return acc;
                }, {});

                const labels = Object.keys(categoryTotals);
                const data = Object.values(categoryTotals);
                const backgroundColors = ['#38bdf8', '#fbbf24', '#f87171', '#4ade80', '#a78bfa', '#fb923c'];

                if (expensesChartInstance) expensesChartInstance.destroy();
                expensesChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels, datasets: [{ label: 'ค่าใช้จ่าย', data, backgroundColor: backgroundColors.slice(0, labels.length), hoverOffset: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }

            function showReceipt(bookingId) {
                // ... (โค้ด showReceipt เหมือนเดิมกับเวอร์ชันล่าสุดที่ผมให้ไป รวมถึง toThaiBahtText)
                console.log("Showing receipt for booking ID:", bookingId);
                const booking = bookings.find(b => b.ID == bookingId); 
                if (!booking) { console.error("Booking not found for receipt:", bookingId); showAlert('ไม่พบข้อมูลการจองสำหรับใบเสร็จนี้', false); return; }

                const days = calculateParkingDays(booking.DropoffDate, booking.PickupDate);
                const { subtotal, vat, total } = calculateCosts(days);
                
                function toThaiBahtText(num) {
                    num = parseFloat(num);
                    if (isNaN(num)) return "จำนวนเงินไม่ถูกต้อง";
                
                    let bahtText = "";
                    let units = ["", "สิบ", "ร้อย", "พัน", "หมื่น", "แสน", "ล้าน"];
                    let digits = ["ศูนย์", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า", "หก", "เจ็ด", "แปด", "เก้า"];
                
                    let numberStr = num.toFixed(2).toString();
                    let [integerPart, decimalPart] = numberStr.split(".");
                
                    if (integerPart === "0" && parseInt(decimalPart) === 0) { 
                        return "ศูนย์บาทถ้วน";
                    }
                     if (integerPart === "0" && parseInt(decimalPart) !== 0) { 
                     } else if (integerPart !== "0") {
                        let inputLength = integerPart.length;
                        for (let i = 0; i < inputLength; i++) {
                            let digit = parseInt(integerPart[i]);
                            if (digit !== 0) {
                                if (digit === 1 && i === inputLength - 1 && inputLength > 1 && integerPart[inputLength-2] !== '0') { 
                                     bahtText += "เอ็ด";
                                } else if (digit === 2 && i === inputLength - 2 && inputLength > 1) { 
                                    bahtText += "ยี่";
                                } else if (digit === 1 && i === inputLength - 2 && inputLength > 1) { 
                                }
                                else {
                                    bahtText += digits[digit];
                                }
                                bahtText += units[inputLength - i - 1];
                            }
                        }
                        bahtText += "บาท";
                     }
                
                    if (decimalPart === "00" || parseInt(decimalPart) === 0) {
                        if (integerPart !== "0" || (integerPart === "0" && parseInt(decimalPart) === 0) ) bahtText += "ถ้วน"; 
                    } else {
                        let decimalLength = decimalPart.length;
                        for (let i = 0; i < decimalLength; i++) {
                             let digit = parseInt(decimalPart[i]);
                             if (digit !== 0) {
                                if (digit === 1 && i === decimalLength - 1 && decimalLength > 1 && decimalPart[decimalLength-2] !== '0') {
                                     bahtText += "เอ็ด";
                                } else if (digit === 2 && i === decimalLength - 2 && decimalLength > 1) {
                                    bahtText += "ยี่";
                                } else if (digit === 1 && i === decimalLength - 2 && decimalLength > 1) {
                                }
                                else {
                                    bahtText += digits[digit];
                                }
                                bahtText += units[decimalLength - i - 1];
                             }
                        }
                        bahtText += "สตางค์";
                    }
                    return bahtText;
                }
                
                const receiptModalContentEl = document.getElementById('receipt-modal-content');
                if(!receiptModalContentEl) { console.error("Receipt modal content element not found!"); return; }

                receiptModalContentEl.innerHTML = `
                    <div class="space-y-4 text-sm text-slate-700">
                        <div class="text-center">
                            <h2 class="text-xl font-bold text-slate-900">ใบเสร็จรับเงิน / ใบฝากรถ</h2>
                            <p>บริษัท ลานจอดรถ แสนสบาย จำกัด</p>
                            <p>เลขประจำตัวผู้เสียภาษี: 0123456789012</p>
                        </div>
                        <div class="border-t border-b border-dashed py-2 flex justify-between">
                            <p>เลขที่: B${String(booking.ID).padStart(5, '0')}</p>
                            <p>วันที่: ${getThaiDate(new Date().toISOString())}</p>
                        </div>
                        <div>
                            <p><strong>ชื่อลูกค้า:</strong> ${booking.CustomerName || 'N/A'}</p>
                            <p><strong>ทะเบียนรถ:</strong> ${booking.CarPlate || 'N/A'} (${booking.CarMake || ''} ${booking.CarModel || ''}, ${booking.CarColor || ''})</p>
                        </div>
                        <div class="border-t pt-2">
                             <p><strong>วันเข้าจอด:</strong> ${getThaiDate(booking.DropoffDate)}</p>
                             <p><strong>วันรับรถคืน:</strong> ${getThaiDate(booking.PickupDate)}</p>
                             <p><strong>จำนวน:</strong> ${days} วัน</p>
                        </div>
                        <table class="w-full mt-2">
                            <tbody class="border-t border-b border-dashed">
                                <tr>
                                    <td class="py-1">ค่าบริการจอดรถ (${days} วัน x ฿${DAILY_RATE})</td>
                                    <td class="py-1 text-right">฿${subtotal.toFixed(2)}</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr><td class="pt-2 text-right">รวมเป็นเงิน</td><td class="pt-2 text-right">฿${subtotal.toFixed(2)}</td></tr>
                                <tr><td class="text-right">ภาษีมูลค่าเพิ่ม 7%</td><td class="text-right">฿${vat.toFixed(2)}</td></tr>
                                <tr><td class="font-bold text-base text-right">ยอดรวมสุทธิ</td><td class="font-bold text-base text-right">฿${total.toFixed(2)}</td></tr>
                                <tr><td colspan="2" class="text-right">(${toThaiBahtText(total)})</td></tr>
                            </tfoot>
                        </table>
                        <div class="flex justify-end space-x-4 mt-6">
                           <button id="receipt-close-button" class="px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300">ปิด</button>
                           <button id="receipt-print-button" class="px-4 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700">พิมพ์</button>
                        </div>
                    </div>
                `;
                
                const modal = document.getElementById('receipt-modal');
                if (modal) {
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    modal.querySelector('.modal-content')?.classList.remove('scale-95');

                    document.getElementById('receipt-close-button')?.addEventListener('click', () => {
                        modal.classList.add('opacity-0', 'pointer-events-none');
                        modal.querySelector('.modal-content')?.classList.add('scale-95');
                    });
                    document.getElementById('receipt-print-button')?.addEventListener('click', () => {
                        window.print();
                    });
                } else { console.error("Receipt modal element not found!");}
            }
            
            function showAlert(message, isSuccess = true) {
                const alertEl = document.getElementById('alert-message');
                if (!alertEl) { console.warn("Alert element not found, cannot show message:", message); return;}
                alertEl.textContent = message;
                alertEl.className = `fixed top-5 right-5 text-white py-2 px-6 rounded-lg shadow-lg transition-all duration-300 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
                alertEl.classList.remove('opacity-0', 'translate-y-10');

                set(() => {
                    alertEl.classList.add('opacity-0', 'translate-y-10');
                }, 3000);
            }

            // --- Event Listeners ---
             if (tabs && sections) { 
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => navigateTo(tab.dataset.tab));
                });
            }
            
            if (customerBookingForm) {
                customerBookingForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("Customer booking form submitted.");
                    const newBooking = {
                        customerName: document.getElementById('customer-name').value,
                        phone: document.getElementById('customer-phone').value,
                        email: document.getElementById('customer-email').value,
                        carMake: document.getElementById('car-make').value,
                        carModel: document.getElementById('car-model').value,
                        carColor: document.getElementById('car-color').value,
                        carPlate: document.getElementById('car-plate').value,
                        dropoffDate: document.getElementById('dropoff-date').value,
                        pickupDate: document.getElementById('pickup-date').value,
                        paymentStatus: 'รอชำระเงิน'
                    };

                    if (new Date(newBooking.pickupDate) < new Date(newBooking.dropoffDate)) {
                        showAlert('วันที่รับรถคืนต้องไม่เร็วกว่าวันที่นำรถมาฝาก', false);
                        return;
                    }
                    
                    console.log("New booking data to send:", newBooking);
                    showAlert('กำลังส่งข้อมูลการจอง...', true);

                    try {
                        const response = await fetch(WEB_APP_URL, {
                            method: 'POST',
                            mode: 'no-cors', // <--- ลองใช้ no-cors สำหรับ POST
                            cache: 'no-cache',
                            // headers: { 'Content-Type': 'application/json' }, // <--- ลองเอาออกเมื่อใช้ no-cors
                            body: JSON.stringify({ action: 'addBooking', data: newBooking })
                        });
                        
                        // เมื่อใช้ no-cors, เราไม่สามารถตรวจสอบ response.ok หรือ response.json()
                        console.log("Add booking request sent (mode: no-cors).");
                        
                        customerBookingForm.reset();
                        setTimeout(async () => {
                            showAlert('ข้อมูลการจองถูกส่งไปแล้ว กำลังอัปเดตรายการ...');
                            await loadBookings(); 
                            navigateTo('bookings');
                        }, 10000); // เพิ่มดีเลย์เพื่อให้ Apps Script มีเวลาประมวลผล

                    } catch (error) {
                        console.error('Error adding booking (fetch with no-cors):', error);
                        showAlert('เกิดข้อผิดพลาดในการส่งข้อมูลการจอง: ' + error.message, false);
                    }
                });
            }

            if (expenseForm) {
                expenseForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("Expense form submitted.");
                    const newExpense = {
                        date: document.getElementById('expense-date').value,
                        description: document.getElementById('expense-description').value,
                        amount: parseFloat(document.getElementById('expense-amount').value),
                        category: document.getElementById('expense-category').value
                    };
                    console.log("New expense data to send:", newExpense);
                    showAlert('กำลังส่งข้อมูลค่าใช้จ่าย...', true);

                    try {
                        const response = await fetch(WEB_APP_URL, {
                            method: 'POST',
                            mode: 'no-cors', // <--- ลองใช้ no-cors สำหรับ POST
                            cache: 'no-cache',
                            // headers: { 'Content-Type': 'application/json' }, // <--- ลองเอาออกเมื่อใช้ no-cors
                            body: JSON.stringify({ action: 'addExpense', data: newExpense })
                        });

                        console.log("Add expense request sent (mode: no-cors).");

                        expenseForm.reset();
                        setTimeout(async () => {
                            showAlert('ข้อมูลค่าใช้จ่ายถูกส่งไปแล้ว กำลังอัปเดตรายการ...');
                            await loadExpenses();
                        }, 10000);

                    } catch (error) {
                        console.error('Error adding expense (fetch with no-cors):', error);
                        showAlert('เกิดข้อผิดพลาดในการส่งข้อมูลค่าใช้จ่าย: ' + error.message, false);
                    }
                });
            }
            
            if (bookingSearchInput) {
                bookingSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filtered = (bookings || []).filter(b => 
                        (b.CustomerName || '').toLowerCase().includes(searchTerm) ||
                        (b.CarPlate || '').toLowerCase().includes(searchTerm)
                    );
                    renderBookingsTable(filtered);
                });
            }

            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-receipt-btn')) {
                    const bookingId = parseInt(e.target.dataset.id);
                    showReceipt(bookingId);
                }
            });
            
            document.body.addEventListener('change', async (e) => {
                if (e.target.classList.contains('payment-status-select')) {
                    const bookingId = parseInt(e.target.dataset.id);
                    const newStatus = e.target.value;
                    console.log(`Payment status change attempt for booking ID ${bookingId} to ${newStatus}`);
                    
                    showAlert('กำลังอัปเดตสถานะ...', true);
                    try {
                        const response = await fetch(WEB_APP_URL, {
                            method: 'POST',
                            mode: 'no-cors', // <--- ลองใช้ no-cors สำหรับ POST
                            cache: 'no-cache',
                            // headers: { 'Content-Type': 'application/json' }, // <--- ลองเอาออกเมื่อใช้ no-cors
                            body: JSON.stringify({ action: 'updateBookingStatus', data: { bookingId: bookingId, newStatus: newStatus } })
                        });

                        console.log("Update status request sent (mode: no-cors).");
                        
                        // อัปเดต UI ทันที และหวังว่า server จะอัปเดตตาม
                        e.target.className = `payment-status-select text-sm rounded-lg border-slate-300 p-1 ${newStatus === 'ชำระแล้ว' ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800'}`;
                        const bookingToUpdate = bookings.find(b => b.ID == bookingId);
                        if (bookingToUpdate) bookingToUpdate.PaymentStatus = newStatus;
                        updateDashboard(); // อัปเดต dashboard ทันทีด้วยข้อมูล local

                        setTimeout(async () => {
                             showAlert('สถานะถูกส่งไปอัปเดตแล้ว กำลังโหลดข้อมูลใหม่...');
                             await loadBookings(); // โหลดข้อมูลใหม่เพื่อยืนยัน (หรือถ้า server fail จะ revert UI)
                        }, 10000);

                    } catch (error) {
                        console.error('Error updating booking status (fetch with no-cors):', error);
                        showAlert('เกิดข้อผิดพลาดในการส่งข้อมูลอัปเดตสถานะ: ' + error.message, false);
                        await loadBookings(); // โหลดข้อมูลใหม่เพื่อ revert UI change
                    }
                }
            });

            // --- Initial App Setup ---
            async function initializeApp() {
                console.log("Initializing app data from Google Sheets...");
                
                if (!WEB_APP_URL || WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') { 
                    showAlert('กรุณาตั้งค่า WEB_APP_URL ในโค้ด JavaScript ก่อน!', false); 
                    console.error("WEB_APP_URL is not set. Please replace 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' with your actual Google Apps Script Web App URL.");
                    if(bookingsTableBody) bookingsTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-red-500">ข้อผิดพลาด: ไม่ได้ตั้งค่า URL ของ Web App</td></tr>';
                    if(expensesTableBody) expensesTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-red-500">ข้อผิดพลาด: ไม่ได้ตั้งค่า URL ของ Web App</td></tr>';
                    return; 
                }
                
                await loadBookings(); 
                await loadExpenses(); 
                updateDashboard(); // เรียก updateDashboard หลังจากโหลดข้อมูลเสร็จ

                const initialTab = window.location.hash.replace('#', '') || 'dashboard';
                navigateTo(initialTab); 
                
                const expenseDateInput = document.getElementById('expense-date');
                if (expenseDateInput) expenseDateInput.valueAsDate = new Date();
                
                const dropoffDateInput = document.getElementById('dropoff-date');
                if (dropoffDateInput) dropoffDateInput.valueAsDate = new Date();
                
                const pickupDateInput = document.getElementById('pickup-date');
                if (pickupDateInput) {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    pickupDateInput.valueAsDate = tomorrow;
                }
                console.log("App initialization complete.");
            }

            initializeApp();

        });
    </script>
</body>
</html>
